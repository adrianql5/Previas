<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>üçª Previas - Juego de Beber</title>
    
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Vue 3 CDN -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    
    <!-- Firebase SDK 9+ (Modular via CDN) -->
    <script type="module">
        // Firebase imports
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getDatabase, ref, set, push, onValue, update, remove, get, child, onDisconnect } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';
        
        // ============================================================
        // üî• FIREBASE CONFIGURATION - PLACEHOLDER
        // ============================================================
        // Reemplaza estos valores con tus credenciales de Firebase
        // Puedes obtenerlas en: https://console.firebase.google.com
        // ============================================================
        const firebaseConfig = {
            apiKey: "PLACEHOLDER_API_KEY",
            authDomain: "PLACEHOLDER_AUTH_DOMAIN",
            databaseURL: "PLACEHOLDER_DATABASE_URL",
            projectId: "PLACEHOLDER_PROJECT_ID",
            storageBucket: "PLACEHOLDER_STORAGE_BUCKET",
            messagingSenderId: "PLACEHOLDER_MESSAGING_SENDER_ID",
            appId: "PLACEHOLDER_APP_ID"
        };
        // ============================================================
        // FIN DE CONFIGURACI√ìN DE FIREBASE
        // ============================================================
        
        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        
        // Expose Firebase functions globally for Vue
        window.firebaseDB = {
            database,
            ref,
            set,
            push,
            onValue,
            update,
            remove,
            get,
            child,
            onDisconnect
        };
        
        // Initialize Vue App after Firebase is ready
        window.firebaseReady = true;
        window.dispatchEvent(new Event('firebase-ready'));
    </script>
    
    <style>
        /* Custom Tailwind Config */
        :root {
            --neon-pink: #ff2d75;
            --neon-cyan: #00f5ff;
            --neon-purple: #7c3aed;
            --dark-bg: #0f0f1a;
            --card-bg: #1a1a2e;
        }
        
        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            background: var(--dark-bg);
            min-height: 100vh;
            font-family: 'Segoe UI', system-ui, sans-serif;
            overflow-x: hidden;
        }
        
        /* Animated gradient background */
        .animated-bg {
            background: linear-gradient(135deg, #0f0f1a 0%, #1a1a2e 50%, #0f0f1a 100%);
            background-size: 400% 400%;
            animation: gradientShift 15s ease infinite;
        }
        
        @keyframes gradientShift {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }
        
        /* Neon glow effects */
        .neon-pink {
            box-shadow: 0 0 20px rgba(255, 45, 117, 0.5),
                        0 0 40px rgba(255, 45, 117, 0.3),
                        0 0 60px rgba(255, 45, 117, 0.1);
        }
        
        .neon-cyan {
            box-shadow: 0 0 20px rgba(0, 245, 255, 0.5),
                        0 0 40px rgba(0, 245, 255, 0.3),
                        0 0 60px rgba(0, 245, 255, 0.1);
        }
        
        .neon-purple {
            box-shadow: 0 0 20px rgba(124, 58, 237, 0.5),
                        0 0 40px rgba(124, 58, 237, 0.3),
                        0 0 60px rgba(124, 58, 237, 0.1);
        }
        
        /* Glowing text */
        .glow-text {
            text-shadow: 0 0 10px rgba(255, 45, 117, 0.8),
                         0 0 20px rgba(255, 45, 117, 0.6),
                         0 0 30px rgba(255, 45, 117, 0.4);
        }
        
        .glow-text-cyan {
            text-shadow: 0 0 10px rgba(0, 245, 255, 0.8),
                         0 0 20px rgba(0, 245, 255, 0.6),
                         0 0 30px rgba(0, 245, 255, 0.4);
        }
        
        /* Button styles */
        .btn-neon {
            position: relative;
            padding: 16px 32px;
            border-radius: 12px;
            font-weight: 700;
            font-size: 1.1rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: all 0.3s ease;
            cursor: pointer;
            border: none;
            min-height: 56px;
        }
        
        .btn-pink {
            background: linear-gradient(135deg, #ff2d75 0%, #ff6b9d 100%);
            color: white;
        }
        
        .btn-pink:hover {
            transform: translateY(-2px);
            box-shadow: 0 0 30px rgba(255, 45, 117, 0.7),
                        0 0 60px rgba(255, 45, 117, 0.4);
        }
        
        .btn-pink:active {
            transform: translateY(0);
        }
        
        .btn-cyan {
            background: linear-gradient(135deg, #00f5ff 0%, #00c4cc 100%);
            color: #0f0f1a;
        }
        
        .btn-cyan:hover {
            transform: translateY(-2px);
            box-shadow: 0 0 30px rgba(0, 245, 255, 0.7),
                        0 0 60px rgba(0, 245, 255, 0.4);
        }
        
        .btn-purple {
            background: linear-gradient(135deg, #7c3aed 0%, #a855f7 100%);
            color: white;
        }
        
        .btn-purple:hover {
            transform: translateY(-2px);
            box-shadow: 0 0 30px rgba(124, 58, 237, 0.7),
                        0 0 60px rgba(124, 58, 237, 0.4);
        }
        
        /* Card styles */
        .card {
            background: rgba(26, 26, 46, 0.9);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 24px;
        }
        
        /* Input styles */
        .input-neon {
            background: rgba(15, 15, 26, 0.8);
            border: 2px solid rgba(0, 245, 255, 0.3);
            border-radius: 12px;
            padding: 16px;
            color: white;
            font-size: 1rem;
            width: 100%;
            transition: all 0.3s ease;
            min-height: 56px;
        }
        
        .input-neon:focus {
            outline: none;
            border-color: #00f5ff;
            box-shadow: 0 0 20px rgba(0, 245, 255, 0.3);
        }
        
        .input-neon::placeholder {
            color: rgba(255, 255, 255, 0.4);
        }
        
        /* Player list */
        .player-item {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 12px 16px;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: all 0.3s ease;
        }
        
        .player-item.active {
            background: rgba(255, 45, 117, 0.2);
            border: 1px solid rgba(255, 45, 117, 0.5);
        }
        
        .player-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
        }
        
        /* Challenge card animation */
        .challenge-card {
            animation: slideIn 0.5s ease-out;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(30px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }
        
        /* Pulse animation for current player */
        .pulse {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        /* Floating emojis */
        .floating-emoji {
            position: fixed;
            font-size: 2rem;
            animation: float 20s infinite linear;
            opacity: 0.3;
            pointer-events: none;
            z-index: 0;
        }
        
        @keyframes float {
            0% {
                transform: translateY(100vh) rotate(0deg);
                opacity: 0;
            }
            10% { opacity: 0.3; }
            90% { opacity: 0.3; }
            100% {
                transform: translateY(-100vh) rotate(360deg);
                opacity: 0;
            }
        }
        
        /* Room code display */
        .room-code {
            font-family: 'Courier New', monospace;
            font-size: 2.5rem;
            font-weight: bold;
            letter-spacing: 8px;
            background: linear-gradient(135deg, #ff2d75, #00f5ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        /* Category badges */
        .category-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        /* Fade transition */
        .fade-enter-active,
        .fade-leave-active {
            transition: opacity 0.3s ease;
        }
        
        .fade-enter-from,
        .fade-leave-to {
            opacity: 0;
        }
        
        /* Responsive adjustments */
        @media (max-width: 640px) {
            .room-code {
                font-size: 2rem;
                letter-spacing: 6px;
            }
        }
        
        /* Scrollbar styling */
        ::-webkit-scrollbar {
            width: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
        }
        
        ::-webkit-scrollbar-thumb {
            background: rgba(255, 45, 117, 0.5);
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 45, 117, 0.7);
        }
    </style>
</head>
<body class="animated-bg min-h-screen">
    <div id="app">
        <!-- Floating background emojis -->
        <div class="floating-emoji" style="left: 10%; animation-delay: 0s;">üç∫</div>
        <div class="floating-emoji" style="left: 30%; animation-delay: 3s;">üéâ</div>
        <div class="floating-emoji" style="left: 50%; animation-delay: 6s;">üçª</div>
        <div class="floating-emoji" style="left: 70%; animation-delay: 9s;">ü•≥</div>
        <div class="floating-emoji" style="left: 90%; animation-delay: 12s;">üéä</div>
        
        <!-- Main Container -->
        <div class="min-h-screen flex flex-col items-center justify-center p-4 relative z-10">
            
            <!-- START SCREEN -->
            <div v-if="screen === 'start'" class="w-full max-w-md">
                <div class="text-center mb-8">
                    <h1 class="text-5xl font-bold text-white glow-text mb-2">üçª PREVIAS</h1>
                    <p class="text-gray-400 text-lg">El juego de beber definitivo</p>
                </div>
                
                <div class="card space-y-4">
                    <!-- Create Room Button -->
                    <button @click="createRoom" class="btn-neon btn-pink w-full">
                        üé≤ Crear Sala
                    </button>
                    
                    <div class="flex items-center gap-4 my-6">
                        <div class="flex-1 h-px bg-gradient-to-r from-transparent via-gray-600 to-transparent"></div>
                        <span class="text-gray-500 text-sm">o</span>
                        <div class="flex-1 h-px bg-gradient-to-r from-transparent via-gray-600 to-transparent"></div>
                    </div>
                    
                    <!-- Join Room Form -->
                    <div class="space-y-4">
                        <input 
                            v-model="playerName" 
                            type="text" 
                            placeholder="Tu nombre..."
                            class="input-neon"
                            maxlength="15"
                        >
                        <input 
                            v-model="roomCodeInput" 
                            type="text" 
                            placeholder="C√≥digo de sala (4 letras)"
                            class="input-neon text-center uppercase"
                            maxlength="4"
                            @input="roomCodeInput = roomCodeInput.toUpperCase()"
                        >
                        <button 
                            @click="joinRoom" 
                            class="btn-neon btn-cyan w-full"
                            :disabled="!playerName || roomCodeInput.length !== 4"
                            :class="{'opacity-50 cursor-not-allowed': !playerName || roomCodeInput.length !== 4}"
                        >
                            üöÄ Unirse a Sala
                        </button>
                    </div>
                </div>
                
                <p v-if="errorMessage" class="text-red-400 text-center mt-4 animate-pulse">
                    {{ errorMessage }}
                </p>
            </div>
            
            <!-- NAME INPUT FOR ROOM CREATOR -->
            <div v-if="screen === 'name'" class="w-full max-w-md">
                <div class="text-center mb-8">
                    <h1 class="text-4xl font-bold text-white glow-text mb-2">üëã ¬øC√≥mo te llamas?</h1>
                </div>
                
                <div class="card space-y-4">
                    <input 
                        v-model="playerName" 
                        type="text" 
                        placeholder="Tu nombre..."
                        class="input-neon text-center text-xl"
                        maxlength="15"
                        autofocus
                    >
                    <button 
                        @click="confirmCreateRoom" 
                        class="btn-neon btn-pink w-full"
                        :disabled="!playerName"
                        :class="{'opacity-50 cursor-not-allowed': !playerName}"
                    >
                        ‚ú® Crear Sala
                    </button>
                    <button @click="screen = 'start'" class="text-gray-400 hover:text-white transition-colors w-full py-2">
                        ‚Üê Volver
                    </button>
                </div>
            </div>
            
            <!-- LOBBY SCREEN -->
            <div v-if="screen === 'lobby'" class="w-full max-w-md">
                <div class="text-center mb-6">
                    <p class="text-gray-400 mb-2">C√≥digo de sala:</p>
                    <p class="room-code">{{ roomCode }}</p>
                    <button 
                        @click="copyRoomCode" 
                        class="text-cyan-400 text-sm mt-2 hover:text-cyan-300 transition-colors"
                    >
                        üìã {{copied ? '¬°Copiado!' : 'Copiar c√≥digo'}}
                    </button>
                </div>
                
                <div class="card">
                    <h2 class="text-xl font-bold text-white mb-4 flex items-center gap-2">
                        <span class="text-2xl">üë•</span> 
                        Jugadores ({{ Object.keys(players).length }})
                    </h2>
                    
                    <div class="space-y-2 mb-6 max-h-60 overflow-y-auto">
                        <div 
                            v-for="(player, id) in players" 
                            :key="id"
                            class="player-item"
                        >
                            <div class="player-avatar bg-gradient-to-br from-pink-500 to-purple-600">
                                {{ player.name.charAt(0).toUpperCase() }}
                            </div>
                            <span class="text-white font-medium flex-1">{{ player.name }}</span>
                            <span v-if="id === hostId" class="text-yellow-400 text-sm">üëë Host</span>
                        </div>
                        
                        <div v-if="Object.keys(players).length === 0" class="text-center text-gray-500 py-4">
                            Esperando jugadores...
                        </div>
                    </div>
                    
                    <!-- Host controls -->
                    <div v-if="isHost">
                        <button 
                            @click="startGame" 
                            class="btn-neon btn-purple w-full"
                            :disabled="Object.keys(players).length < 2"
                            :class="{'opacity-50 cursor-not-allowed': Object.keys(players).length < 2}"
                        >
                            üéÆ Empezar Partida
                        </button>
                        <p v-if="Object.keys(players).length < 2" class="text-gray-500 text-sm text-center mt-2">
                            Necesitas al menos 2 jugadores
                        </p>
                    </div>
                    <div v-else class="text-center">
                        <p class="text-gray-400 pulse">‚è≥ Esperando que el host inicie...</p>
                    </div>
                </div>
                
                <button @click="leaveRoom" class="text-gray-500 hover:text-red-400 transition-colors w-full py-4 mt-2">
                    üö™ Abandonar Sala
                </button>
            </div>
            
            <!-- GAME SCREEN -->
            <div v-if="screen === 'game'" class="w-full max-w-md">
                <!-- Turn indicator -->
                <div class="text-center mb-4">
                    <p class="text-gray-400 text-sm">Turno {{ currentTurn + 1 }}</p>
                </div>
                
                <!-- Current player -->
                <div class="text-center mb-6">
                    <p class="text-gray-400 mb-1">Le toca a:</p>
                    <p class="text-3xl font-bold text-white glow-text-cyan">
                        {{ currentPlayerName }}
                    </p>
                </div>
                
                <!-- Challenge card -->
                <div class="card challenge-card mb-6" :key="currentTurn">
                    <div class="text-center">
                        <!-- Category badge -->
                        <span 
                            class="category-badge mb-4"
                            :style="{ background: getCategoryColor(currentChallengeData?.category) }"
                        >
                            {{ getCategoryEmoji(currentChallengeData?.category) }} {{ currentChallengeData?.category }}
                        </span>
                        
                        <!-- Challenge text -->
                        <p class="text-2xl text-white font-medium mt-4 leading-relaxed">
                            {{ currentChallenge }}
                        </p>
                    </div>
                </div>
                
                <!-- Player list (compact) -->
                <div class="card mb-4">
                    <div class="flex flex-wrap gap-2 justify-center">
                        <div 
                            v-for="(player, id) in players" 
                            :key="id"
                            class="px-3 py-1 rounded-full text-sm transition-all"
                            :class="id === currentPlayerId ? 'bg-pink-500 text-white neon-pink' : 'bg-gray-800 text-gray-400'"
                        >
                            {{ player.name }}
                        </div>
                    </div>
                </div>
                
                <!-- Next turn button -->
                <button 
                    @click="nextTurn" 
                    class="btn-neon btn-pink w-full"
                >
                    ‚è≠Ô∏è Siguiente Turno
                </button>
                
                <button @click="leaveRoom" class="text-gray-500 hover:text-red-400 transition-colors w-full py-4 mt-2">
                    üö™ Abandonar Partida
                </button>
            </div>
            
        </div>
    </div>
    
    <script>
        // Wait for Firebase to be ready
        function initApp() {
            const { createApp, ref: vueRef, onMounted, onUnmounted, computed, watch } = Vue;
            
            // ============================================================
            // üéÆ CHALLENGES / DESAF√çOS
            // ============================================================
            const challenges = [
                // YO NUNCA
                { category: "Yo Nunca", text: "Yo nunca... he besado a alguien en esta sala üíã" },
                { category: "Yo Nunca", text: "Yo nunca... me he quedado dormido/a en un bar üò¥" },
                { category: "Yo Nunca", text: "Yo nunca... he enviado un mensaje borracho/a del que me arrepiento üì±" },
                { category: "Yo Nunca", text: "Yo nunca... he fingido estar sobrio/a delante de mis padres ü§´" },
                { category: "Yo Nunca", text: "Yo nunca... he vomitado en un taxi üöï" },
                { category: "Yo Nunca", text: "Yo nunca... he llorado por una pel√≠cula üé¨" },
                { category: "Yo Nunca", text: "Yo nunca... he stalkeado a un ex en redes sociales üëÄ" },
                
                // VERDAD O RETO
                { category: "Verdad", text: "¬øCu√°l es tu secreto m√°s vergonzoso? Confiesa o bebe 3 tragos ü§ê" },
                { category: "Verdad", text: "¬øCon qui√©n de esta sala te ir√≠as de vacaciones? üèñÔ∏è" },
                { category: "Reto", text: "Imita a otro jugador hasta que alguien adivine qui√©n es üé≠" },
                { category: "Reto", text: "Mant√©n contacto visual con alguien durante 30 segundos sin re√≠rte üëÅÔ∏è" },
                { category: "Reto", text: "Deja tu tel√©fono desbloqueado 1 minuto para que cualquiera lea üì±" },
                { category: "Reto", text: "Haz tu mejor intento de baile sexy üíÉ" },
                
                // CASCADA
                { category: "Cascada", text: "¬°CASCADA! Todos beben en orden, solo puedes parar cuando pare el de tu izquierda üåä" },
                { category: "Cascada", text: "¬°MINI CASCADA! Cuenta hasta 5 mientras todos beben üî¢" },
                
                // REGLA NUEVA
                { category: "Regla Nueva", text: "Nueva regla: Nadie puede decir 'yo' hasta el pr√≥ximo turno. El que lo diga, bebe üôä" },
                { category: "Regla Nueva", text: "Nueva regla: Antes de beber hay que hacer un brindis. El que no lo haga, bebe doble ü•Ç" },
                { category: "Regla Nueva", text: "Nueva regla: Solo se puede beber con la mano izquierda. El que use la derecha, bebe extra üñêÔ∏è" },
                
                // TOMA X
                { category: "Toma", text: "Todos los que tengan pareja, ¬°bebed! üíë" },
                { category: "Toma", text: "Quien haya llegado tarde hoy, bebe 2 tragos ‚è∞" },
                { category: "Toma", text: "El m√°s joven de la sala bebe üçº" },
                { category: "Toma", text: "Quien tenga el pelo m√°s largo, bebe üíá" },
                { category: "Toma", text: "Todos los que lleven algo azul, ¬°bebed! üíô" },
                { category: "Toma", text: "Quien haya mirado el m√≥vil en los √∫ltimos 5 minutos, bebe üì≤" },
                
                // ELIGE A ALGUIEN
                { category: "Elige", text: "Elige a alguien para que se tome 3 tragos üéØ" },
                { category: "Elige", text: "Elige a alguien para intercambiar bebidas üîÑ" },
                { category: "Elige", text: "Elige a 2 personas: deben mantener los me√±iques entrelazados hasta el pr√≥ximo turno ü§ô" },
                { category: "Elige", text: "Elige a alguien para hacer un duelo: piedra, papel o tijera. El perdedor bebe ‚úÇÔ∏è" },
                
                // GRUPALES
                { category: "Grupal", text: "¬°Todos beben! üç∫üç∫üç∫" },
                { category: "Grupal", text: "El √∫ltimo en tocar el suelo, bebe üëá" },
                { category: "Grupal", text: "El primero en nombrar 5 capitales europeas se salva, los dem√°s beben üåç" },
                { category: "Grupal", text: "Quien tenga el cumplea√±os m√°s cercano, reparte 3 tragos como quiera üéÇ" }
            ];
            
            const app = createApp({
                setup() {
                    const { database, ref: dbRef, set, push, onValue, update, remove, get, child, onDisconnect } = window.firebaseDB;
                    
                    // State
                    const screen = vueRef('start');
                    const playerName = vueRef('');
                    const roomCode = vueRef('');
                    const roomCodeInput = vueRef('');
                    const playerId = vueRef('');
                    const hostId = vueRef('');
                    const players = vueRef({});
                    const currentTurn = vueRef(0);
                    const currentChallenge = vueRef('');
                    const currentPlayerId = vueRef('');
                    const currentChallengeData = vueRef(null);
                    const errorMessage = vueRef('');
                    const copied = vueRef(false);
                    const unsubscribers = vueRef([]);
                    
                    // Computed
                    const isHost = computed(() => playerId.value === hostId.value);
                    const currentPlayerName = computed(() => {
                        if (currentPlayerId.value && players.value[currentPlayerId.value]) {
                            return players.value[currentPlayerId.value].name;
                        }
                        return '...';
                    });
                    
                    // Methods
                    const generateRoomCode = () => {
                        const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
                        let code = '';
                        for (let i = 0; i < 4; i++) {
                            code += chars.charAt(Math.floor(Math.random() * chars.length));
                        }
                        return code;
                    };
                    
                    const generatePlayerId = () => {
                        return 'player_' + Math.random().toString(36).substr(2, 9);
                    };
                    
                    const createRoom = () => {
                        screen.value = 'name';
                    };
                    
                    const confirmCreateRoom = async () => {
                        if (!playerName.value.trim()) return;
                        
                        roomCode.value = generateRoomCode();
                        playerId.value = generatePlayerId();
                        hostId.value = playerId.value;
                        
                        try {
                            // Create room in Firebase
                            const roomRef = dbRef(database, `rooms/${roomCode.value}`);
                            await set(roomRef, {
                                host: playerId.value,
                                status: 'waiting',
                                currentTurn: 0,
                                currentChallenge: '',
                                currentPlayer: '',
                                createdAt: Date.now()
                            });
                            
                            // Add player
                            const playerRef = dbRef(database, `rooms/${roomCode.value}/players/${playerId.value}`);
                            await set(playerRef, {
                                name: playerName.value.trim(),
                                joinedAt: Date.now()
                            });
                            
                            // Setup disconnect handler
                            onDisconnect(playerRef).remove();
                            
                            // Subscribe to room updates
                            subscribeToRoom();
                            
                            screen.value = 'lobby';
                        } catch (error) {
                            console.error('Error creating room:', error);
                            errorMessage.value = 'Error al crear la sala. Revisa tu conexi√≥n.';
                        }
                    };
                    
                    const joinRoom = async () => {
                        if (!playerName.value.trim() || roomCodeInput.value.length !== 4) return;
                        
                        roomCode.value = roomCodeInput.value.toUpperCase();
                        playerId.value = generatePlayerId();
                        
                        try {
                            // Check if room exists
                            const roomRef = dbRef(database, `rooms/${roomCode.value}`);
                            const snapshot = await get(roomRef);
                            
                            if (!snapshot.exists()) {
                                errorMessage.value = 'Sala no encontrada. Verifica el c√≥digo.';
                                return;
                            }
                            
                            const roomData = snapshot.val();
                            if (roomData.status === 'playing') {
                                errorMessage.value = 'La partida ya ha comenzado.';
                                return;
                            }
                            
                            hostId.value = roomData.host;
                            
                            // Add player to room
                            const playerRef = dbRef(database, `rooms/${roomCode.value}/players/${playerId.value}`);
                            await set(playerRef, {
                                name: playerName.value.trim(),
                                joinedAt: Date.now()
                            });
                            
                            // Setup disconnect handler
                            onDisconnect(playerRef).remove();
                            
                            // Subscribe to room updates
                            subscribeToRoom();
                            
                            screen.value = 'lobby';
                            errorMessage.value = '';
                        } catch (error) {
                            console.error('Error joining room:', error);
                            errorMessage.value = 'Error al unirse. Revisa tu conexi√≥n.';
                        }
                    };
                    
                    const subscribeToRoom = () => {
                        const roomRef = dbRef(database, `rooms/${roomCode.value}`);
                        
                        const unsubscribe = onValue(roomRef, (snapshot) => {
                            if (!snapshot.exists()) {
                                // Room was deleted
                                cleanup();
                                screen.value = 'start';
                                errorMessage.value = 'La sala ha sido cerrada.';
                                return;
                            }
                            
                            const data = snapshot.val();
                            hostId.value = data.host;
                            players.value = data.players || {};
                            
                            if (data.status === 'playing') {
                                screen.value = 'game';
                                currentTurn.value = data.currentTurn || 0;
                                currentChallenge.value = data.currentChallenge || '';
                                currentPlayerId.value = data.currentPlayer || '';
                                
                                // Find challenge data
                                const found = challenges.find(c => c.text === data.currentChallenge);
                                currentChallengeData.value = found || null;
                            }
                        });
                        
                        unsubscribers.value.push(unsubscribe);
                    };
                    
                    const startGame = async () => {
                        if (!isHost.value) return;
                        
                        const playerIds = Object.keys(players.value);
                        if (playerIds.length < 2) return;
                        
                        // Select random first player and challenge
                        const firstPlayer = playerIds[Math.floor(Math.random() * playerIds.length)];
                        const firstChallenge = challenges[Math.floor(Math.random() * challenges.length)];
                        
                        try {
                            const roomRef = dbRef(database, `rooms/${roomCode.value}`);
                            await update(roomRef, {
                                status: 'playing',
                                currentTurn: 0,
                                currentPlayer: firstPlayer,
                                currentChallenge: firstChallenge.text
                            });
                        } catch (error) {
                            console.error('Error starting game:', error);
                        }
                    };
                    
                    const nextTurn = async () => {
                        const playerIds = Object.keys(players.value);
                        if (playerIds.length === 0) return;
                        
                        // Select next player (could be random or sequential)
                        const nextPlayer = playerIds[Math.floor(Math.random() * playerIds.length)];
                        const nextChallenge = challenges[Math.floor(Math.random() * challenges.length)];
                        
                        try {
                            const roomRef = dbRef(database, `rooms/${roomCode.value}`);
                            await update(roomRef, {
                                currentTurn: currentTurn.value + 1,
                                currentPlayer: nextPlayer,
                                currentChallenge: nextChallenge.text
                            });
                        } catch (error) {
                            console.error('Error advancing turn:', error);
                        }
                    };
                    
                    const leaveRoom = async () => {
                        try {
                            const playerRef = dbRef(database, `rooms/${roomCode.value}/players/${playerId.value}`);
                            await remove(playerRef);
                            
                            // If host leaves and game hasn't started, delete room
                            if (isHost.value) {
                                const roomRef = dbRef(database, `rooms/${roomCode.value}`);
                                const snapshot = await get(roomRef);
                                if (snapshot.exists()) {
                                    const data = snapshot.val();
                                    if (data.status === 'waiting' || Object.keys(data.players || {}).length <= 1) {
                                        await remove(roomRef);
                                    }
                                }
                            }
                        } catch (error) {
                            console.error('Error leaving room:', error);
                        }
                        
                        cleanup();
                        screen.value = 'start';
                    };
                    
                    const cleanup = () => {
                        unsubscribers.value.forEach(unsub => unsub());
                        unsubscribers.value = [];
                        players.value = {};
                        currentTurn.value = 0;
                        currentChallenge.value = '';
                        currentPlayerId.value = '';
                        roomCode.value = '';
                        roomCodeInput.value = '';
                    };
                    
                    const copyRoomCode = async () => {
                        try {
                            await navigator.clipboard.writeText(roomCode.value);
                            copied.value = true;
                            setTimeout(() => copied.value = false, 2000);
                        } catch (error) {
                            console.error('Error copying:', error);
                        }
                    };
                    
                    const getCategoryColor = (category) => {
                        const colors = {
                            'Yo Nunca': 'linear-gradient(135deg, #ff2d75, #ff6b9d)',
                            'Verdad': 'linear-gradient(135deg, #00f5ff, #00c4cc)',
                            'Reto': 'linear-gradient(135deg, #7c3aed, #a855f7)',
                            'Cascada': 'linear-gradient(135deg, #3b82f6, #60a5fa)',
                            'Regla Nueva': 'linear-gradient(135deg, #f59e0b, #fbbf24)',
                            'Toma': 'linear-gradient(135deg, #10b981, #34d399)',
                            'Elige': 'linear-gradient(135deg, #ec4899, #f472b6)',
                            'Grupal': 'linear-gradient(135deg, #8b5cf6, #a78bfa)'
                        };
                        return colors[category] || 'linear-gradient(135deg, #6b7280, #9ca3af)';
                    };
                    
                    const getCategoryEmoji = (category) => {
                        const emojis = {
                            'Yo Nunca': 'üôÖ',
                            'Verdad': 'ü§î',
                            'Reto': 'üé≠',
                            'Cascada': 'üåä',
                            'Regla Nueva': 'üìú',
                            'Toma': 'üç∫',
                            'Elige': 'üëÜ',
                            'Grupal': 'üë•'
                        };
                        return emojis[category] || 'üé≤';
                    };
                    
                    // Cleanup on unmount
                    onUnmounted(() => {
                        cleanup();
                    });
                    
                    return {
                        screen,
                        playerName,
                        roomCode,
                        roomCodeInput,
                        playerId,
                        hostId,
                        players,
                        currentTurn,
                        currentChallenge,
                        currentPlayerId,
                        currentPlayerName,
                        currentChallengeData,
                        errorMessage,
                        copied,
                        isHost,
                        createRoom,
                        confirmCreateRoom,
                        joinRoom,
                        startGame,
                        nextTurn,
                        leaveRoom,
                        copyRoomCode,
                        getCategoryColor,
                        getCategoryEmoji
                    };
                }
            });
            
            app.mount('#app');
        }
        
        // Initialize when Firebase is ready
        if (window.firebaseReady) {
            initApp();
        } else {
            window.addEventListener('firebase-ready', initApp);
        }
    </script>
</body>
</html>
